var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{V as i,Q as s,X as n,a2 as r,U as a,ai as o,aj as l,ak as h,a as c,al as d,am as u,an as m,ao as p,h as f,ap as g,J as v,D as y,aq as x,ar as w,l as b,as as C,a0 as M,at as T,G as S,au as D,av as z,H as A,aw as P,ax as E,a1 as _,ay as B,az as R,aA as k,E as L,Z as U}from"./three-vendor-ADDqdyWc.js";import{b as F}from"./physics-x5YsX_M8.js";import{G as I,O}from"./three-addons-CRFFrh3W.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const V=2;const N=new class{constructor(){this.level=V,this.prefix="🎮"}setLevel(e){this.level=e}error(e,...t){this.level}warn(e,...t){this.level}info(e,...t){this.level}debug(e,...t){this.level}physics(e,...t){this.level}model(e,...t){this.level}achievement(e,...t){this.level}performance(e,...t){this.level}};function j(e){e.w,e.x,e.y,e.z,e.x,e.x,e.y,e.y;const t=2*(e.w*e.y+e.z*e.x),i=1-2*(e.y*e.y+e.z*e.z);return Math.atan2(t,i)}function G(e){const t=e/2;return{x:0,y:Math.sin(t),z:0,w:Math.cos(t)}}function W(e,t){const n=new i(e.x,e.y,e.z),r=new s(t.x,t.y,t.z,t.w);return n.applyQuaternion(r),{x:n.x,y:n.y,z:n.z}}const H={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class Q{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){}dispose(){}}const q=new r(-1,1,1,-1,0,1);const K=new class extends a{constructor(){super(),this.setAttribute("position",new o([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new o([0,2,0,0,2,0],2))}};class Z{constructor(e){this._mesh=new n(K,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,q)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class Y extends Q{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof l?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=h.clone(e.uniforms),this.material=new l({name:void 0!==e.name?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new Z(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class X extends Q{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const s=e.getContext(),n=e.state;let r,a;n.buffers.color.setMask(!1),n.buffers.depth.setMask(!1),n.buffers.color.setLocked(!0),n.buffers.depth.setLocked(!0),this.inverse?(r=0,a=1):(r=1,a=0),n.buffers.stencil.setTest(!0),n.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),n.buffers.stencil.setFunc(s.ALWAYS,r,4294967295),n.buffers.stencil.setClear(a),n.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),n.buffers.color.setLocked(!1),n.buffers.depth.setLocked(!1),n.buffers.color.setMask(!0),n.buffers.depth.setMask(!0),n.buffers.stencil.setLocked(!1),n.buffers.stencil.setFunc(s.EQUAL,1,4294967295),n.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),n.buffers.stencil.setLocked(!0)}}class J extends Q{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class ${constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),void 0===t){const i=e.getSize(new c);this._width=i.width,this._height=i.height,(t=new d(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:u})).texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new Y(H),this.copyPass.material.blending=m,this.clock=new p}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;for(let s=0,n=this.passes.length;s<n;s++){const t=this.passes[s];if(!1!==t.enabled){if(t.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),t.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),t.needsSwap){if(i){const t=this.renderer.getContext(),i=this.renderer.state.buffers.stencil;i.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),i.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==X&&(t instanceof X?i=!0:t instanceof J&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new c);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(let n=0;n<this.passes.length;n++)this.passes[n].setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class ee extends Q{constructor(e,t,i=null,s=null,n=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=s,this.clearAlpha=n,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new f}render(e,t,i){const s=e.autoClear;let n,r;e.autoClear=!1,null!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),null!==this.clearAlpha&&(n=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),!0===this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),null!==this.clearColor&&e.setClearColor(this._oldClearColor),null!==this.clearAlpha&&e.setClearAlpha(n),null!==this.overrideMaterial&&(this.scene.overrideMaterial=r),e.autoClear=s}}const te={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new f(0)},defaultOpacity:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat v = luminance( texel.xyz );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}"};class ie extends Q{constructor(e,t=1,s,n){super(),this.strength=t,this.radius=s,this.threshold=n,this.resolution=void 0!==e?new c(e.x,e.y):new c(256,256),this.clearColor=new f(0,0,0),this.needsSwap=!1,this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let r=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new d(r,a,{type:u}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let i=0;i<this.nMips;i++){const e=new d(r,a,{type:u});e.texture.name="UnrealBloomPass.h"+i,e.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(e);const t=new d(r,a,{type:u});t.texture.name="UnrealBloomPass.v"+i,t.texture.generateMipmaps=!1,this.renderTargetsVertical.push(t),r=Math.round(r/2),a=Math.round(a/2)}const o=te;this.highPassUniforms=h.clone(o.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new l({uniforms:this.highPassUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}),this.separableBlurMaterials=[];const m=[3,5,7,9,11];r=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);for(let i=0;i<this.nMips;i++)this.separableBlurMaterials.push(this._getSeparableBlurMaterial(m[i])),this.separableBlurMaterials[i].uniforms.invSize.value=new c(1/r,1/a),r=Math.round(r/2),a=Math.round(a/2);this.compositeMaterial=this._getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new i(1,1,1),new i(1,1,1),new i(1,1,1),new i(1,1,1),new i(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,this.copyUniforms=h.clone(H.uniforms),this.blendMaterial=new l({uniforms:this.copyUniforms,vertexShader:H.vertexShader,fragmentShader:H.fragmentShader,blending:g,depthTest:!1,depthWrite:!1,transparent:!0}),this._oldClearColor=new f,this._oldClearAlpha=1,this._basic=new v,this._fsQuad=new Z(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this._basic.dispose(),this._fsQuad.dispose()}setSize(e,t){let i=Math.round(e/2),s=Math.round(t/2);this.renderTargetBright.setSize(i,s);for(let n=0;n<this.nMips;n++)this.renderTargetsHorizontal[n].setSize(i,s),this.renderTargetsVertical[n].setSize(i,s),this.separableBlurMaterials[n].uniforms.invSize.value=new c(1/i,1/s),i=Math.round(i/2),s=Math.round(s/2)}render(e,t,i,s,n){e.getClearColor(this._oldClearColor),this._oldClearAlpha=e.getClearAlpha();const r=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),n&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this._fsQuad.material=this._basic,this._basic.map=i.texture,e.setRenderTarget(null),e.clear(),this._fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this._fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this._fsQuad.render(e);let a=this.renderTargetBright;for(let o=0;o<this.nMips;o++)this._fsQuad.material=this.separableBlurMaterials[o],this.separableBlurMaterials[o].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[o].uniforms.direction.value=ie.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[o]),e.clear(),this._fsQuad.render(e),this.separableBlurMaterials[o].uniforms.colorTexture.value=this.renderTargetsHorizontal[o].texture,this.separableBlurMaterials[o].uniforms.direction.value=ie.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[o]),e.clear(),this._fsQuad.render(e),a=this.renderTargetsVertical[o];this._fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this._fsQuad.render(e),this._fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,n&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(i),this._fsQuad.render(e)),e.setClearColor(this._oldClearColor,this._oldClearAlpha),e.autoClear=r}_getSeparableBlurMaterial(e){const t=[];for(let i=0;i<e;i++)t.push(.39894*Math.exp(-.5*i*i/(e*e))/e);return new l({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new c(.5,.5)},direction:{value:new c(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})}_getCompositeMaterial(e){return new l({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}"})}}ie.BlurDirectionX=new c(1,0),ie.BlurDirectionY=new c(0,1);const se={uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float offset;\n        uniform float darkness;\n        varying vec2 vUv;\n\n        void main() {\n            vec4 texel = texture2D(tDiffuse, vUv);\n            vec2 uv = (vUv - vec2(0.5)) * vec2(offset);\n            float vignette = 1.0 - dot(uv, uv);\n            vignette = clamp(pow(vignette, darkness), 0.0, 1.0);\n            texel.rgb *= vignette;\n            gl_FragColor = texel;\n        }\n    "},ne={uniforms:{tDiffuse:{value:null},brightness:{value:0},contrast:{value:1},saturation:{value:1}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float brightness;\n        uniform float contrast;\n        uniform float saturation;\n        varying vec2 vUv;\n\n        void main() {\n            vec4 texel = texture2D(tDiffuse, vUv);\n\n            // Brightness\n            texel.rgb += brightness;\n\n            // Contrast\n            texel.rgb = (texel.rgb - 0.5) * contrast + 0.5;\n\n            // Saturation\n            float gray = dot(texel.rgb, vec3(0.299, 0.587, 0.114));\n            texel.rgb = mix(vec3(gray), texel.rgb, saturation);\n\n            gl_FragColor = texel;\n        }\n    "},re={uniforms:{tDiffuse:{value:null},resolution:{value:new c(1/1024,1/512)},amount:{value:.5}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform vec2 resolution;\n        uniform float amount;\n        varying vec2 vUv;\n\n        void main() {\n            vec2 step = resolution;\n\n            vec3 texA = texture2D(tDiffuse, vUv + vec2(-step.x, -step.y)).rgb;\n            vec3 texB = texture2D(tDiffuse, vUv + vec2( step.x, -step.y)).rgb;\n            vec3 texC = texture2D(tDiffuse, vUv + vec2(-step.x,  step.y)).rgb;\n            vec3 texD = texture2D(tDiffuse, vUv + vec2( step.x,  step.y)).rgb;\n\n            vec3 around = 0.25 * (texA + texB + texC + texD);\n            vec3 center = texture2D(tDiffuse, vUv).rgb;\n\n            vec3 col = center + (center - around) * amount;\n\n            gl_FragColor = vec4(col, 1.0);\n        }\n    "};const ae=1.8,oe=16774630,le={x:50,y:80,z:30},he=.8,ce=8900331,de=13808780,ue=1,me=16777215,pe=8900331,fe=12968950,ge=8e-4,ve=.3,ye=.1,xe=1.15,we=.5,be=1.2,Ce=13162726,Me={x:-50,y:60,z:-30},Te=.7,Se=3821412,De=4872814,ze=.8,Ae=9083816,Pe=2767434,Ee=3820122,_e=.0012,Be=.7,Re=.05,ke=.95,Le=.6;class Ue{constructor(e,t){this.scene=e,this.renderer=t,this.timeOfDay=0,this.isTransitioning=!1,this.transitionDuration=3e3,this.transitionStartTime=0,this.transitionStartValue=0,this.transitionTargetValue=0,this.lights={sun:null,hemisphere:null,ambient:null,pointLight:null},this.composer=null,this.fog=null}setupLights(){this.lights.sun=new y(oe,ae),this.lights.sun.position.set(le.x,le.y,le.z),this.lights.sun.castShadow=this.renderer.shadowMap.enabled,this.lights.sun.castShadow&&(this.lights.sun.shadow.mapSize.width=2048,this.lights.sun.shadow.mapSize.height=2048,this.lights.sun.shadow.camera.near=.5,this.lights.sun.shadow.camera.far=500,this.lights.sun.shadow.camera.left=-100,this.lights.sun.shadow.camera.right=100,this.lights.sun.shadow.camera.top=100,this.lights.sun.shadow.camera.bottom=-100),this.scene.add(this.lights.sun),this.lights.hemisphere=new x(ce,de,he),this.lights.hemisphere.position.set(0,50,0),this.scene.add(this.lights.hemisphere),this.lights.ambient=new w(me,ue),this.scene.add(this.lights.ambient),this.lights.pointLight=new b(16766720,.2,50),this.lights.pointLight.position.set(0,5,0),this.scene.add(this.lights.pointLight),this.scene.background=new f(pe),this.fog=new C(fe,ge),this.scene.fog=this.fog}setComposer(e){this.composer=e}toggle(){if(this.isTransitioning)return;this.isTransitioning=!0,this.transitionStartTime=Date.now(),this.transitionStartValue=this.timeOfDay,this.transitionTargetValue=0===this.timeOfDay?1:0;this.transitionTargetValue}lerp(e,t,i){return e+(t-e)*i}lerpColor(e,t,i){const s=new f(e),n=new f(t);return s.lerp(n,i)}easeInOutCubic(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}update(){if(!this.isTransitioning)return;const e=Date.now()-this.transitionStartTime;let t=Math.min(e/this.transitionDuration,1);if(t=this.easeInOutCubic(t),this.timeOfDay=this.lerp(this.transitionStartValue,this.transitionTargetValue,t),this.applyLighting(this.timeOfDay),t>=1){this.isTransitioning=!1;this.timeOfDay}}applyLighting(e){if(this.lights.sun&&(this.lights.sun.intensity=this.lerp(ae,be,e),this.lights.sun.color=this.lerpColor(oe,Ce,e),this.lights.sun.position.x=this.lerp(le.x,Me.x,e),this.lights.sun.position.y=this.lerp(le.y,Me.y,e),this.lights.sun.position.z=this.lerp(le.z,Me.z,e)),this.lights.hemisphere&&(this.lights.hemisphere.intensity=this.lerp(he,Te,e),this.lights.hemisphere.color=this.lerpColor(ce,Se,e),this.lights.hemisphere.groundColor=this.lerpColor(de,De,e)),this.lights.ambient&&(this.lights.ambient.intensity=this.lerp(ue,ze,e),this.lights.ambient.color=this.lerpColor(me,Ae,e)),this.scene.background=this.lerpColor(pe,Pe,e),this.fog&&(this.fog.color=this.lerpColor(fe,Ee,e),this.fog.density=this.lerp(ge,_e,e)),this.composer&&this.composer.passes){const t=this.composer.passes.find(e=>"UnrealBloomPass"===e.constructor.name);t&&(t.strength=this.lerp(ve,Be,e));const i=this.composer.passes.find(e=>e.uniforms&&e.uniforms.brightness);i&&(i.uniforms.brightness.value=this.lerp(ye,Re,e),i.uniforms.saturation.value=this.lerp(xe,ke,e));const s=this.composer.passes.find(e=>e.uniforms&&e.uniforms.darkness);s&&(s.uniforms.darkness.value=this.lerp(we,Le,e))}}setDay(){this.timeOfDay=0,this.isTransitioning=!1,this.applyLighting(0)}setNight(){this.timeOfDay=1,this.isTransitioning=!1,this.applyLighting(1)}isDay(){return this.timeOfDay<.5}dispose(){Object.values(this.lights).forEach(e=>{e&&(this.scene.remove(e),e.dispose&&e.dispose())})}}let Fe=null;const Ie=new I;async function Oe(e){const t=new M;try{const e=await async function(){return Fe?Fe.clone():new Promise((e,t)=>{Ie.load("/lampadaire_stylise.glb",t=>{Fe=t.scene,e(Fe.clone())},e=>{(e.loaded/e.total*100).toFixed(0)},e=>{t(e)})})}();e.scale.set(1,1,1),e.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(e);let s=null,r=new i(0,3.8,0);if(e.traverse(e=>{e.isMesh&&(e.name.toLowerCase().includes("lamp")||e.name.toLowerCase().includes("light")||e.name.toLowerCase().includes("bulb"))&&(s=e,r.copy(e.position))}),s)s.material&&(s.material.emissive=new f(16768392),s.material.emissiveIntensity=0);else{const e=new T(.2,16,16),i=new S({color:16768392,emissive:16768392,emissiveIntensity:0,metalness:.2,roughness:.1});s=new n(e,i),s.position.copy(r),t.add(s)}}catch(l){const e=new D(.1,.12,4,8),i=new S({color:3815994,metalness:.8,roughness:.3}),s=new n(e,i);s.position.y=2,s.castShadow=!0,t.add(s)}const s=new b(16768392,0,15,2);s.position.set(0,3.8,0),s.castShadow=!0,s.shadow.mapSize.width=512,s.shadow.mapSize.height=512,t.add(s);const r=new T(.5,16,16),a=new v({color:16768392,transparent:!0,opacity:0,side:z}),o=new n(r,a);return o.position.set(0,3.8,0),o.scale.set(1.5,1.5,1.5),t.add(o),t.position.copy(e),t.userData={pointLight:s,glow:o,glowMaterial:a,isLit:!1,targetIntensity:0},t}let Ve=null;const Ne=new I;async function je(e=1){const t=new M;try{const i=await async function(){return Ve?Ve.clone():new Promise((e,t)=>{Ne.load("/cactus.glb",t=>{Ve=t.scene,e(Ve.clone())},e=>{(e.loaded/e.total*100).toFixed(0)},e=>{t(e)})})}(),s=50*e;i.scale.set(s,s,s),i.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(i)}catch(i){const s=new S({color:4881486,roughness:.9,metalness:.1}),r=3*e,a=.4*e,o=new D(a,.9*a,r,8),l=new n(o,s);l.position.y=r/2,l.castShadow=!0,l.receiveShadow=!0,t.add(l)}return t}function Ge(e,t){const i=Math.abs(e)<10&&Math.abs(t)<30,s=Math.abs(t)<10&&Math.abs(e)<30;return i||s}const We={position:{x:0,y:.55,z:0},rotation:{y:0}},He=class e{static createCollidersFromModel(t,i,s={}){const n={autoDetect:!0,filterType:null,verbose:!0,includeInvisible:!1,forceAll:!1,simplify:!0,maxTrianglesPerCollider:1e3,...s},r={total:0,created:0,skipped:0,vertices:0,triangles:0,types:{}};t.updateMatrixWorld(!0);const a=i.createRigidBody(F.RigidBodyDesc.fixed());return t.traverse(t=>{if(!t.isMesh||!t.geometry)return;if(!t.visible&&!n.includeInvisible)return void r.skipped++;if(r.total++,n.forceAll){const e=this.createColliderForMesh(t,i,"ground",n.verbose,!0,{simplify:n.simplify,maxTrianglesPerCollider:n.maxTrianglesPerCollider,sharedBody:a});return void(e.created?(r.created++,r.vertices+=e.vertices,r.triangles+=e.triangles,r.types.ground=(r.types.ground||0)+1):r.skipped++)}const s=n.autoDetect?this.detectColliderType(t):n.filterType||e.ColliderType.AUTO;if(n.filterType&&s!==n.filterType)return void r.skipped++;const o=this.createColliderForMesh(t,i,s,n.verbose,!1,{simplify:n.simplify,maxTrianglesPerCollider:n.maxTrianglesPerCollider,sharedBody:a});o.created?(r.created++,r.vertices+=o.vertices,r.triangles+=o.triangles,r.types[s]=(r.types[s]||0)+1):(r.skipped++,n.verbose)}),r}static detectColliderType(t){const s=t.geometry;s.boundingBox||s.computeBoundingBox();const n=s.boundingBox;t.updateWorldMatrix(!0,!1);const r=new i;r.setFromMatrixPosition(t.matrixWorld);const a=Math.abs(n.max.y-n.min.y),o=r.y+(n.max.y+n.min.y)/2,l=Math.abs(n.max.x-n.min.x),h=Math.abs(n.max.z-n.min.z),c=s.index?s.index.count/3:s.attributes.position.count/3;if(a>30||o>40)return e.ColliderType.BUILDING;if(c<3)return e.ColliderType.DECORATION;if(a>15&&a<30){if(l<1.5||h<1.5)return e.ColliderType.WALL}return e.ColliderType.GROUND}static simplifyGeometry(e,t,i){const s=t.length/3;if(s<=i)return{vertices:e,indices:t};let n=i;s>3e3&&(n=Math.max(Math.floor(.5*s),i)),n=Math.max(n,50);const r=n/s,a=[],o=Math.max(1,Math.floor(1/r));for(let l=0;l<t.length&&!(a.length/3>=n);l+=3*o)l+2<t.length&&a.push(t[l],t[l+1],t[l+2]);return a.length<150?{vertices:e,indices:t}:{vertices:e,indices:new Uint32Array(a)}}static createColliderForMesh(e,t,s,n=!1,r=!1,o={}){const l=this.DefaultConfig[s];if(!(r||l&&l.createCollider))return{created:!1,reason:"Type does not create colliders"};const h=e.geometry,c=h.isBufferGeometry?h:(new a).fromGeometry(h),d=c.getAttribute("position");if(!d)return{created:!1,reason:"No position attribute"};const u=new Float32Array(d.array);let m;if(c.index)m=new Uint32Array(c.index.array);else{const e=u.length/3;m=new Uint32Array(e);for(let t=0;t<e;t++)m[t]=t}let p=m.length/3;if(!r&&l&&p<l.minTriangles)return{created:!1,reason:`Too few triangles (${p})`};if(o.simplify&&o.maxTrianglesPerCollider&&p>o.maxTrianglesPerCollider){m=this.simplifyGeometry(u,m,o.maxTrianglesPerCollider).indices,p=m.length/3}e.updateWorldMatrix(!0,!1);const f=e.matrixWorld,g=new Float32Array(u.length),v=new i;for(let i=0;i<u.length;i+=3)v.set(u[i],u[i+1],u[i+2]),v.applyMatrix4(f),g[i]=v.x,g[i+1]=v.y,g[i+2]=v.z;try{const e=l?l.restitution:0,i=l?l.friction:.8,n=F.ColliderDesc.trimesh(g,m).setRestitution(e).setFriction(i),r=o.sharedBody||t.createRigidBody(F.RigidBodyDesc.fixed());return t.createCollider(n,r),{created:!0,vertices:g.length/3,triangles:p,type:s}}catch(y){return{created:!1,reason:y.message}}}static visualizeColliders(e,t,i={}){const s={color:65280,opacity:.3,wireframe:!0,...i},r=new v({color:s.color,transparent:!0,opacity:s.opacity,wireframe:s.wireframe,side:A});t.forEachCollider(t=>{const i=t.shape;if(i.type===F.ShapeType.Cuboid){const s=i.halfExtents,a=new P(2*s.x,2*s.y,2*s.z),o=new n(a,r),l=t.parent(),h=l.translation(),c=l.rotation();o.position.set(h.x,h.y,h.z),o.quaternion.set(c.x,c.y,c.z,c.w),o.userData.isDebugCollider=!0,e.add(o)}})}static removeColliderVisualization(e){const t=[];e.traverse(e=>{e.userData.isDebugCollider&&t.push(e)}),t.forEach(t=>{e.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}static createSafetyFloor(e,t={}){const i={y:-.25,width:1e3,height:.5,depth:1e3,friction:.8,restitution:0,...t},s=F.RigidBodyDesc.fixed().setTranslation(0,i.y,0),n=e.createRigidBody(s),r=F.ColliderDesc.cuboid(i.width/2,i.height/2,i.depth/2).setRestitution(i.restitution).setFriction(i.friction);return e.createCollider(r,n),n}};t(He,"ColliderType",{AUTO:"auto",GROUND:"ground",WALL:"wall",BUILDING:"building",DECORATION:"decoration"}),t(He,"DefaultConfig",{ground:{friction:.8,restitution:0,createCollider:!0,minTriangles:3,maxHeight:15,maxCenterY:40},wall:{friction:.5,restitution:.1,createCollider:!0,minTriangles:3,maxHeight:50,maxCenterY:50},building:{createCollider:!1},decoration:{createCollider:!1}});let Qe=He;console.log=function(){},N.info("Starting Portfolio 3D app...");new class{constructor(){this.clock=new p,this.objects=[],this.world=null,this.car=null,this.keys={},this.cameraTarget=new i,this.particles=[],this.interactiveZones=[],this.currentZone=null,this.font=null,this.speedLines=[],this.exhaustSmoke=[],this.fps=60,this.frameCount=0,this.lastTime=performance.now(),this.collectibles=[],this.score=0,this.audioContext=null,this.engineOscillator=null,this.engineGain=null,this.engineFilter=null,this.minimapCanvas=null,this.minimapCtx=null,this.garageZone=null,this.inGarage=!1,this.boostActive=!1,this.boostEnergy=100,this.boostMaxEnergy=100,this.boostRechargeRate=10,this.boostDrainRate=30,this.boostMultiplier=2.5,this.boostParticles=[],this.boostTrails=[],this.achievements={speedDemon:{unlocked:!1,name:"Speed Demon",desc:"Atteindre 150 km/h"},collector:{unlocked:!1,name:"Collector",desc:"Ramasser 10 étoiles"},explorer:{unlocked:!1,name:"Explorer",desc:"Visiter toutes les zones"},customizer:{unlocked:!1,name:"Customizer",desc:"Personnaliser la voiture"},boostMaster:{unlocked:!1,name:"Boost Master",desc:"Utiliser le boost 20 fois"}},this.achievementNotifications=[],this.boostUseCount=0,this.visitedZones=new Set,this.timeAccumulator=0,this.fixedTimeStep=1/60,this.cameraManualControl=!1,this.cameraAutoTimeout=null,this.cameraAutoDelay=3e3,this.composer=null,this.postProcessingEnabled=!0,this.dayNightCycle=null,this.streetLamps=[],this.cacti=[],this.showColliders=!1,this.init()}async init(){try{await F.init(),this.createScene(),this.createPhysicsWorld(),this.createCamera(),this.createRenderer(),this.createControls(),this.floorMaterial=await(e=this.scene,t=this.world,this.objects,new Promise((i,s)=>{const n=F.RigidBodyDesc.fixed().setTranslation(0,0,0),r=t.createRigidBody(n),a=F.ColliderDesc.cuboid(500,.5,500);t.createCollider(a,r),(new I).load("/xbox360_cars_the_video_game_radiator_springs.glb",s=>{const n=s.scene;n.position.set(0,0,0),n.scale.set(20,20,20),n.traverse(e=>{if(e.isMesh){if(e.material){const t=Array.isArray(e.material)?e.material:[e.material];let i=!1;if(t.forEach(e=>{if(e.color){const t=e.color.getHex();(0===t||t<657930)&&(i=!0)}e.transparent&&e.opacity<.1&&!e.map&&(i=!0)}),i)return void(e.visible=!1)}e.castShadow=!0,e.receiveShadow=!0}}),e.add(n),n.updateMatrixWorld(!0),Qe.createCollidersFromModel(n,t,{autoDetect:!0,includeInvisible:!1,simplify:!1,verbose:!0}),Qe.createSafetyFloor(t,{y:-.25,width:1e3,depth:1e3,height:.5,friction:.8}),t.removeRigidBody(r),i(null)},e=>{(e.loaded/e.total*100).toFixed(0)},e=>{s(e)})})),this.createCar(),this.addEventListeners(),this.initMinimap(),this.loadAchievements(),this.initPostProcessing(),this.streetLamps=await async function(e){const t=[],s=[new i(3,0,-20),new i(3,0,-13),new i(3,0,-6),new i(3,0,1),new i(3,0,8),new i(3,0,15),new i(3,0,22),new i(10,0,-3),new i(-4,0,-3)];for(const i of s){const s=await Oe(i);e.add(s),t.push(s)}return t}(this.scene),this.cacti=await async function(e){const t=[],s=[{x:-50,z:60,count:5,spread:20},{x:0,z:60,count:4,spread:15},{x:50,z:60,count:5,spread:20},{x:-50,z:-60,count:5,spread:20},{x:0,z:-60,count:4,spread:15},{x:50,z:-60,count:5,spread:20},{x:60,z:0,count:6,spread:25},{x:70,z:30,count:4,spread:15},{x:70,z:-30,count:4,spread:15},{x:-60,z:0,count:6,spread:25},{x:-70,z:30,count:4,spread:15},{x:-70,z:-30,count:4,spread:15}];for(const n of s)for(let s=0;s<n.count;s++){let s,r,a,o=0;const l=10;do{s=(Math.random()-.5)*n.spread,r=(Math.random()-.5)*n.spread,a=new i(n.x+s,0,n.z+r),o++}while(Ge(a.x,a.z)&&o<l);if(Ge(a.x,a.z))continue;const h=.8+.4*Math.random(),c=await je(h);c.position.copy(a),c.rotation.y=Math.random()*Math.PI*2,c.rotation.x=.1*(Math.random()-.5),c.rotation.z=.1*(Math.random()-.5),e.add(c),t.push(c)}return t}(this.scene),document.getElementById("loading").style.display="none",this.animate()}catch(s){document.getElementById("loading").textContent="Error: "+s.message}var e,t}createScene(){this.scene=new E}createPhysicsWorld(){this.world=new F.World({x:0,y:-25,z:0})}createCamera(){this.camera=new _(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,8,12),this.camera.lookAt(0,0,0)}createRenderer(){const e=window.devicePixelRatio<2||navigator.hardwareConcurrency&&navigator.hardwareConcurrency<4;this.renderer=new B({antialias:!e,powerPreference:"high-performance"}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,e?1:1.5)),this.renderer.shadowMap.enabled=!e,this.renderer.shadowMap.enabled&&(this.renderer.shadowMap.type=R);document.getElementById("canvas-container").appendChild(this.renderer.domElement)}createControls(){this.controls=new O(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.target.set(0,0,0),this.controls.enabled=!1,this.controls.minPolarAngle=0,this.controls.maxPolarAngle=Math.PI/2+.3,this.controls.minDistance=3,this.controls.maxDistance=50,this.controls.addEventListener("start",()=>{this.enableManualCamera()}),this.controls.addEventListener("change",()=>{this.cameraManualControl&&this.resetCameraAutoTimeout()})}initPostProcessing(){try{const e=function(e,t,i,s={}){const{enableBloom:n=!0,enableVignette:r=!0,enableColorGrading:a=!0,enableSharpen:o=!1,bloomStrength:l=.6,bloomRadius:h=.4,bloomThreshold:d=.85}=s,u=new $(e);u.setSize(window.innerWidth,window.innerHeight);const m=new ee(t,i);if(u.addPass(m),n){const e=new ie(new c(window.innerWidth,window.innerHeight),l,h,d);u.addPass(e)}if(a){const e=new Y(ne);e.uniforms.brightness.value=.15,e.uniforms.contrast.value=1.1,e.uniforms.saturation.value=1.2,u.addPass(e)}if(o){const e=new Y(re);e.uniforms.resolution.value=new c(1/window.innerWidth,1/window.innerHeight),e.uniforms.amount.value=.3,u.addPass(e)}if(r){const e=new Y(se);e.uniforms.offset.value=1.3,e.uniforms.darkness.value=.8,e.renderToScreen=!0,u.addPass(e)}const p=()=>{u.setSize(window.innerWidth,window.innerHeight)};return window.addEventListener("resize",p),{composer:u,onWindowResize:p,dispose:()=>{window.removeEventListener("resize",p),u.dispose()}}}(this.renderer,this.scene,this.camera,{enableBloom:!0,enableVignette:!0,enableColorGrading:!0,enableSharpen:!1,bloomStrength:.6,bloomRadius:.4,bloomThreshold:.85});this.composer=e.composer,this.initDayNightCycle()}catch(e){this.postProcessingEnabled=!1}}initDayNightCycle(){this.dayNightCycle=new Ue(this.scene,this.renderer),this.dayNightCycle.setupLights(),this.composer&&this.dayNightCycle.setComposer(this.composer)}createCar(){const e=.5,t=new M;t.position.set(0,3,0),this.scene.add(t);(new I).load("/lightning_mcqueen_cars_3.glb",i=>{const s=i.scene;s.scale.set(e,e,e),s.position.set(0,-.75,0),s.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(s)},e=>{(e.loaded/e.total*100).toFixed(0)},e=>{});const i=F.ColliderDesc.cuboid(.5,.55,.75).setRestitution(0).setFriction(.3).setDensity(2),s=We.position,n=We.rotation,r=F.RigidBodyDesc.dynamic().setTranslation(s.x,s.y,s.z).setRotation(G(n.y)).setLinearDamping(.3).setAngularDamping(1.5).setCanSleep(!1),a=this.world.createRigidBody(r);this.world.createCollider(i,a),a.lockRotations(!1,!1),a.setEnabledRotations(!1,!0,!1,!0),this.car={mesh:t,body:a,speed:0,maxSpeed:35,acceleration:0,steering:0,maxSteering:.05,driftParticles:[],wheels:[],headlights:[]},this.objects.push(this.car)}addEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),window.addEventListener("keydown",e=>{const t=this.keys[e.code];this.keys[e.code]=!0,"Space"===e.code&&!t&&this.car&&this.car.speed>5&&this.playBrakeSound(),"Enter"===e.code&&this.currentZone&&this.hideZoneContent(),"KeyC"===e.code&&this.disableManualCamera(),"KeyN"===e.code&&this.dayNightCycle&&this.dayNightCycle.toggle(),"KeyV"===e.code&&this.toggleColliderVisualization()}),window.addEventListener("keyup",e=>{this.keys[e.code]=!1}),this.renderer.domElement.addEventListener("click",e=>{this.audioContext||this.initAudio(),this.handleClick(e)}),this.renderer.domElement.addEventListener("mousedown",e=>{2===e.button&&(this.enableManualCamera(),e.preventDefault())}),this.renderer.domElement.addEventListener("contextmenu",e=>{e.preventDefault()})}initAudio(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.engineOscillator=this.audioContext.createOscillator(),this.engineOscillator.type="sawtooth",this.engineOscillator.frequency.value=80,this.engineFilter=this.audioContext.createBiquadFilter(),this.engineFilter.type="lowpass",this.engineFilter.frequency.value=800,this.engineFilter.Q.value=1,this.engineGain=this.audioContext.createGain(),this.engineGain.gain.value=0,this.engineOscillator.connect(this.engineFilter),this.engineFilter.connect(this.engineGain),this.engineGain.connect(this.audioContext.destination),this.engineOscillator.start()}catch(e){}}handleClick(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new c;i.x=(e.clientX-t.left)/t.width*2-1,i.y=-(e.clientY-t.top)/t.height*2+1;const s=new k;s.setFromCamera(i,this.camera);const n=this.objects.map(e=>e.mesh),r=s.intersectObjects(n);if(r.length>0){const e=r[0].object,t=this.objects.find(t=>t.mesh===e);if(t&&t!==this.car){const e={x:0,y:15,z:0};t.body.applyImpulse(e,!0);const i=t.body.translation();this.createParticleExplosion(i)}}}createParticleExplosion(e){const t=new T(.1,4,4);for(let s=0;s<15;s++){const s=new v({color:(new f).setHSL(Math.random(),.8,.6)}),r=new n(t,s);r.position.set(e.x,e.y,e.z);const a=new i(10*(Math.random()-.5),8*Math.random()+2,10*(Math.random()-.5));r.userData={velocity:a,life:1,decay:.02*Math.random()+.01},this.particles.push(r),this.scene.add(r)}}createDriftParticle(){if(!this.car||Math.random()>.5)return;const e=this.car.body.translation(),t=new T(.15,4,4),s=new v({color:11184810,transparent:!0,opacity:.6}),r=new n(t,s),a=W({x:0,y:0,z:-1.5},this.car.body.rotation());r.position.set(e.x+a.x,.4,e.z+a.z),r.userData={velocity:new i(0,.5,0),life:1,decay:.03},this.particles.push(r),this.scene.add(r)}createExhaustSmoke(){if(!this.car||Math.random()>.4)return;const e=this.car.body.translation(),t=this.car.body.rotation(),s=new T(.2,4,4),r=new v({color:8947848,transparent:!0,opacity:.4}),a=new n(s,r),o=W({x:-.6,y:.3,z:-1.6},t);a.position.set(e.x+o.x,e.y+o.y,e.z+o.z);const l=W({x:0,y:.5,z:-1},t);a.userData={velocity:new i(.5*l.x,l.y+.5,.5*l.z),life:1,decay:.015,scale:.2},this.particles.push(a),this.scene.add(a)}createSpeedLines(){if(!this.car||this.car.speed<15)return;if(Math.random()>.5)return;const e=new a,t=new L({color:16777215,transparent:!0,opacity:.6}),s=this.car.body.translation(),n=new i(10*(Math.random()-.5),2*Math.random(),10*(Math.random()-.5)),r=new i(s.x+n.x,s.y+n.y,s.z+n.z),o=W({x:0,y:0,z:1},this.car.body.rotation()),l=[r,new i(r.x-2*o.x,r.y,r.z-2*o.z)];e.setFromPoints(l);const h=new U(e,t);h.userData={life:1,decay:.05},this.speedLines.push(h),this.scene.add(h)}updateSpeedLines(e){if(this.speedLines.length>15){const e=this.speedLines.length-15;for(let t=0;t<e;t++)this.scene.remove(this.speedLines[t]),this.speedLines[t].geometry.dispose(),this.speedLines[t].material.dispose();this.speedLines.splice(0,e)}for(let t=this.speedLines.length-1;t>=0;t--){const e=this.speedLines[t],i=e.userData;i.life-=i.decay,e.material.opacity=.6*i.life,i.life<=0&&(this.scene.remove(e),e.geometry.dispose(),e.material.dispose(),this.speedLines.splice(t,1))}}createBoostParticles(){if(!this.car)return;const e=this.car.body.translation(),t=this.car.body.rotation();for(let s=0;s<2;s++){const s=new T(.2+.1*Math.random(),4,4),r=[16737792,16746496,16755200,65535,35071],a=r[Math.floor(Math.random()*r.length)],o=new v({color:a,transparent:!0,opacity:.8}),l=new n(s,o),h=W({x:1.5*(Math.random()-.5),y:.2+.3*Math.random(),z:-1.8-.5*Math.random()},t);l.position.set(e.x+h.x,e.y+h.y,e.z+h.z);const c=W({x:0,y:0,z:-1},t);l.userData={velocity:new i(-2*c.x+2*(Math.random()-.5),1+2*Math.random(),-2*c.z+2*(Math.random()-.5)),life:1,decay:.02+.01*Math.random(),scale:.2+.1*Math.random(),isBoostParticle:!0},this.boostParticles.push(l),this.particles.push(l),this.scene.add(l)}}updateBoostUI(){const e=document.getElementById("boost-bar"),t=document.getElementById("boost-value");if(e&&t){const i=this.boostEnergy/this.boostMaxEnergy*100;e.style.width=i+"%",t.textContent=Math.round(this.boostEnergy),this.boostActive?(e.style.background="linear-gradient(90deg, #ff6600, #ffaa00)",e.style.boxShadow="0 0 20px rgba(255, 170, 0, 0.8)"):this.boostEnergy<20?(e.style.background="linear-gradient(90deg, #ff4444, #ff6666)",e.style.boxShadow="none"):(e.style.background="linear-gradient(90deg, #4ecdc4, #44ff44)",e.style.boxShadow="none")}}checkAchievement(e){if(!this.achievements[e])return;if(this.achievements[e].unlocked)return;let t=!1;switch(e){case"speedDemon":this.car&&this.car.speed>=150&&(t=!0);break;case"collector":this.score>=10&&(t=!0);break;case"explorer":this.visitedZones.size>=4&&(t=!0);break;case"customizer":localStorage.getItem("carCustomization")&&(t=!0);break;case"boostMaster":this.boostUseCount>=20&&(t=!0)}t&&this.unlockAchievement(e)}unlockAchievement(e){const t=this.achievements[e];if(!t||t.unlocked)return;t.unlocked=!0,this.showAchievementNotification(t);const i=JSON.parse(localStorage.getItem("achievements")||"{}");i[e]=!0,localStorage.setItem("achievements",JSON.stringify(i))}showAchievementNotification(e){const t=document.createElement("div");t.className="achievement-notification",t.innerHTML=`\n            <div class="achievement-icon">🏆</div>\n            <div class="achievement-content">\n                <div class="achievement-title">Achievement Unlocked!</div>\n                <div class="achievement-name">${e.name}</div>\n                <div class="achievement-desc">${e.desc}</div>\n            </div>\n        `,document.body.appendChild(t),setTimeout(()=>{t.style.transform="translateX(0)",t.style.opacity="1"},10),setTimeout(()=>{t.style.transform="translateX(400px)",t.style.opacity="0",setTimeout(()=>{document.body.removeChild(t)},300)},4e3)}loadAchievements(){try{const e=localStorage.getItem("achievements");if(e){const t=JSON.parse(e);for(const e in t)this.achievements[e]&&(this.achievements[e].unlocked=t[e])}}catch(e){}this.checkAchievement("customizer")}updateParticles(e){if(this.particles.length>75){const e=this.particles.length-75;for(let t=0;t<e;t++)this.scene.remove(this.particles[t]);this.particles.splice(0,e)}for(let t=this.particles.length-1;t>=0;t--){const i=this.particles[t],s=i.userData;i.position.add(s.velocity.clone().multiplyScalar(e)),s.scale?(s.velocity.multiplyScalar(.98),s.scale+=.5*e,i.scale.setScalar(s.scale)):s.velocity.y-=25*e,s.life-=s.decay,i.material.opacity=s.life*(s.scale?.4:1),i.material.transparent=!0,s.life<=0&&(this.scene.remove(i),i.geometry.dispose(),i.material.dispose(),this.particles.splice(t,1))}}updateCar(e){if(!this.car)return;let t=0,i=0,s=!1;(this.keys.KeyW||this.keys.ArrowUp)&&(t+=1),(this.keys.KeyS||this.keys.ArrowDown)&&(t-=1),(this.keys.KeyA||this.keys.ArrowLeft)&&(i+=1),(this.keys.KeyD||this.keys.ArrowRight)&&(i-=1),this.keys.Space&&(s=!0);(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.boostEnergy>0&&t>0?this.boostActive||(this.boostActive=!0,this.boostUseCount++,this.checkAchievement("boostMaster")):this.boostActive=!1,this.boostActive&&t>0?(this.boostEnergy=Math.max(0,this.boostEnergy-this.boostDrainRate*e),this.boostEnergy<=0&&(this.boostActive=!1)):this.boostEnergy=Math.min(this.boostMaxEnergy,this.boostEnergy+this.boostRechargeRate*e),this.updateBoostUI();const n=this.car.body,r=this.car,a=n.rotation(),o=j(a);n.angvel(),n.setAngvel({x:0,y:0,z:0},!0);let l=W({x:0,y:0,z:1},a);l.y=0;const h=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z);l.x/=h,l.y/=h,l.z/=h;const c=n.linvel(),d=Math.sqrt(c.x*c.x+c.z*c.z);let u=0;if(d>.05){const e={x:c.x,z:c.z},t=Math.sqrt(e.x*e.x+e.z*e.z);e.x/=t,e.z/=t;u=d*(l.x*e.x+l.z*e.z>=0?1:-1)}if(this.car.currentSpeed||(this.car.currentSpeed=0),d<.05&&(u=this.car.currentSpeed),0!==i&&d>.1){const t=G(o+(u<-.1?-i:i)*2.5*Math.min(d/12,1)*e);n.setRotation(t,!0),d>10&&Math.abs(i)>.5&&this.createDriftParticle()}if(0!==t){const i=this.boostActive?50:35,s=r.maxSpeed,n=this.boostActive?s*this.boostMultiplier:s,a=.6*n;if(this.boostActive&&t>0&&this.createBoostParticles(),t>0)if(u<0)u=Math.min(u+2*i*e,0);else{const t=1-u/n*.7;u=Math.min(u+i*t*e,n)}else u=u>.3?Math.max(u-2.5*i*e,0):Math.max(u-.8*i*e,-a)}else s?u*=.7:(u*=.95,Math.abs(u)<.01&&(u=0));const m={x:l.x*u,y:c.y,z:l.z*u};m.y<-40&&(m.y=-40),n.setLinvel(m,!0),this.car.currentSpeed=u,r.speed=Math.abs(u)}enableManualCamera(){if(!this.cameraManualControl&&(this.cameraManualControl=!0,this.controls.enabled=!0,this.car)){const e=this.car.body.translation();this.controls.target.set(e.x,e.y,e.z)}this.resetCameraAutoTimeout()}disableManualCamera(){this.cameraManualControl=!1,this.controls.enabled=!1,this.cameraAutoTimeout&&(clearTimeout(this.cameraAutoTimeout),this.cameraAutoTimeout=null)}resetCameraAutoTimeout(){this.cameraAutoTimeout&&clearTimeout(this.cameraAutoTimeout),this.cameraAutoTimeout=setTimeout(()=>{this.disableManualCamera()},this.cameraAutoDelay)}updateCamera(){if(!this.car)return;if(this.cameraManualControl){const e=this.car.body.translation();return this.controls.target.lerp(new i(e.x,e.y,e.z),.05),void this.controls.update()}const e=this.car.body.translation(),t=this.car.body.rotation(),s=this.car.speed,n=Math.min(s/12,1.5),r=W({x:0,y:5+.5*n,z:-(10+2*n)},t),a=new i(e.x+r.x,e.y+r.y,e.z+r.z),o=W({x:0,y:.5,z:3+3*n},t),l=new i(e.x+o.x,e.y+o.y,e.z+o.z),h=.05+s/200;this.camera.position.lerp(a,Math.min(h,.15)),this.cameraTarget.lerp(l,.08),this.camera.lookAt(this.cameraTarget)}updateUI(){if(this.car){const e=Math.round(3.6*this.car.speed),t=document.getElementById("speed-value");t&&(t.textContent=e,t.style.color=e>50?"#ff4444":e>25?"#ffaa44":"#44ff44"),e>=150&&this.checkAchievement("speedDemon");const i=document.getElementById("pos-x"),s=document.getElementById("pos-z"),n=this.car.body.translation();i&&(i.textContent=Math.round(n.x)),s&&(s.textContent=Math.round(n.z))}const e=document.getElementById("obj-count");e&&(e.textContent=this.objects.length);const t=document.getElementById("score-value");t&&(t.textContent=this.score),this.frameCount++;const i=performance.now();if(i>=this.lastTime+1e3){this.fps=Math.round(1e3*this.frameCount/(i-this.lastTime)),this.frameCount=0,this.lastTime=i;const e=document.getElementById("fps-count");e&&(e.textContent=this.fps,this.fps>=55?e.style.color="#44ff44":this.fps>=30?e.style.color="#ffaa44":e.style.color="#ff4444")}const s={"About Me":"about",Projects:"projects",Skills:"skills",Contact:"contact"};if(document.querySelectorAll(".zone-item").forEach(e=>{e.classList.remove("active")}),this.currentZone){const e=s[this.currentZone.name],t=document.querySelector(`[data-zone="${e}"]`);t&&t.classList.add("active")}}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updateCollectibles(e){this.collectibles.forEach(e=>{if(e.collected)return;e.mesh.rotation.y+=e.rotationSpeed;const t=.001*Date.now();e.mesh.position.y=e.baseY+.3*Math.sin(t+e.mesh.position.x),e.light.position.y=e.mesh.position.y,e.light.intensity=.3+.2*Math.sin(2*t)})}checkCollectibles(){if(!this.car)return;const e=this.car.body.translation(),t=new i(e.x,e.y,e.z);this.collectibles.forEach(e=>{if(e.collected)return;t.distanceTo(e.mesh.position)<2&&(e.collected=!0,this.score+=10,this.checkAchievement("collector"),this.animateCollection(e),this.createCollectionParticles(e.mesh.position),this.playCollectSound())})}animateCollection(e){e.mesh.scale.clone();const t=Date.now(),i=()=>{const s=Date.now()-t,n=Math.min(s/300,1),r=1+2*n;e.mesh.scale.set(r,r,r),e.mesh.material.opacity=1-n,e.mesh.material.transparent=!0,e.light.intensity*=.9,n<1?requestAnimationFrame(i):(this.scene.remove(e.mesh),this.scene.remove(e.light))};i()}createCollectionParticles(e){const t=new T(.1,4,4);for(let s=0;s<10;s++){const r=new v({color:16768256,transparent:!0,opacity:1}),a=new n(t,r);a.position.copy(e);const o=s/10*Math.PI*2,l=new i(5*Math.cos(o),5*Math.random()+3,5*Math.sin(o));a.userData={velocity:l,life:1,decay:.03},this.particles.push(a),this.scene.add(a)}}toggleColliderVisualization(){this.showColliders=!this.showColliders,this.showColliders?Qe.visualizeColliders(this.scene,this.world,{color:65280,opacity:.5,wireframe:!0}):Qe.removeColliderVisualization(this.scene)}checkGarageProximity(){if(!this.car||!this.garageZone||this.inGarage)return;const e=this.car.body.translation(),t=this.garageZone,i=Math.abs(e.x-t.x)<t.width/2,s=Math.abs(e.z-t.z)<t.depth/2;i&&s&&(this.inGarage=!0,this.enterGarage())}enterGarage(){const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: black;\n            opacity: 0;\n            z-index: 10000;\n            transition: opacity 1s ease-in-out;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-size: 48px;\n            font-family: 'Segoe UI', sans-serif;\n            font-weight: bold;\n        ",e.textContent="GARAGE",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1"},10),setTimeout(()=>{window.location.href="garage.html"},1e3)}playCollectSound(){if(!this.audioContext)return;const e=this.audioContext.currentTime,t=this.audioContext.createOscillator();t.type="sine",t.frequency.setValueAtTime(440,e),t.frequency.exponentialRampToValueAtTime(880,e+.1);const i=this.audioContext.createGain();i.gain.setValueAtTime(.3,e),i.gain.exponentialRampToValueAtTime(.01,e+.2),t.connect(i),i.connect(this.audioContext.destination),t.start(e),t.stop(e+.2)}updateEngineSound(){if(!this.audioContext||!this.car)return;const e=this.car.speed,t=this.car.maxSpeed,i=80+e/t*220;this.engineOscillator.frequency.exponentialRampToValueAtTime(Math.max(i,80),this.audioContext.currentTime+.1);const s=800+e/t*1200;this.engineFilter.frequency.exponentialRampToValueAtTime(s,this.audioContext.currentTime+.1);const n=e>.5?.15+e/t*.1:0;this.engineGain.gain.linearRampToValueAtTime(n,this.audioContext.currentTime+.1)}playBrakeSound(){if(!this.audioContext)return;const e=this.audioContext.currentTime,t=.3*this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),s=i.getChannelData(0);for(let o=0;o<t;o++)s[o]=2*Math.random()-1;const n=this.audioContext.createBufferSource();n.buffer=i;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=2e3;const a=this.audioContext.createGain();a.gain.setValueAtTime(.08,e),a.gain.exponentialRampToValueAtTime(.01,e+.3),n.connect(r),r.connect(a),a.connect(this.audioContext.destination),n.start(e),n.stop(e+.3)}initMinimap(){this.minimapCanvas=document.getElementById("minimap"),this.minimapCanvas&&(this.minimapCtx=this.minimapCanvas.getContext("2d"))}updateMinimap(){if(!this.minimapCtx||!this.car)return;const e=this.minimapCtx,t=this.minimapCanvas.width,i=this.minimapCanvas.height;e.fillStyle="rgba(10, 15, 25, 0.9)",e.fillRect(0,0,t,i);const s=.75,n=t/2,r=i/2,a=this.car.body.translation(),o=a.x,l=a.z;e.fillStyle="rgba(78, 205, 196, 0.3)",this.interactiveZones.forEach(t=>{const i=n+(t.position.x-o)*s,a=r+(t.position.z-l)*s;e.beginPath(),e.arc(i,a,4,0,2*Math.PI),e.fill()}),e.fillStyle="#ffdd00",this.collectibles.forEach(t=>{if(t.collected)return;const i=n+(t.mesh.position.x-o)*s,a=r+(t.mesh.position.z-l)*s;e.beginPath(),e.arc(i,a,2,0,2*Math.PI),e.fill()}),e.save(),e.translate(n,r);const h=j(this.car.body.rotation());e.rotate(-h+Math.PI),e.fillStyle="#ff0000",e.beginPath(),e.moveTo(0,-6),e.lineTo(-4,4),e.lineTo(4,4),e.closePath(),e.fill(),e.restore(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=2,e.strokeRect(0,0,t,i)}animate(){requestAnimationFrame(()=>this.animate());let e=this.clock.getDelta();e=Math.min(e,.1),this.timeAccumulator+=e;let t=0;for(;this.timeAccumulator>=this.fixedTimeStep&&t<5;)this.updateCar(this.fixedTimeStep),this.world.step(),this.frameCount,this.timeAccumulator-=this.fixedTimeStep,t++;if(this.timeAccumulator>5*this.fixedTimeStep&&(this.timeAccumulator=0),this.timeAccumulator,this.fixedTimeStep,this.car&&this.car.mesh&&this.car.body){const e=this.car.body.translation(),t=this.car.body.rotation();this.car.body.linvel();this.frameCount,this.car.mesh.position.lerp(new i(e.x,e.y,e.z),.3),this.car.mesh.quaternion.slerp(new s(t.x,t.y,t.z,t.w),.3)}if(this.objects.forEach(({mesh:e,body:t})=>{if(e!==this.car?.mesh&&e&&t){const n=t.translation(),r=t.rotation();e.position.lerp(new i(n.x,n.y,n.z),.3),e.quaternion.slerp(new s(r.x,r.y,r.z,r.w),.3)}}),this.car&&this.car.wheels){const t=this.car.speed*e*2;if(this.car.wheels.forEach(e=>{e.rotation.x+=t}),this.car.headlights){const e=.5+.8*Math.min(this.car.speed/this.car.maxSpeed,1);this.car.headlights.forEach(t=>{t.intensity=e})}}if(this.updateParticles(e),this.updateSpeedLines(e),this.clouds){const e=.001*Date.now();this.clouds.forEach(t=>{t.position.y=t.userData.baseY+.5*Math.sin(e*t.userData.speed+t.userData.offset),t.rotation.y+=.001})}if(this.animatedObjects){const e=.001*Date.now();this.animatedObjects.forEach(t=>{void 0!==t.userData.baseY&&(t.position.y=t.userData.baseY+.5*Math.sin(e*t.userData.speed+t.userData.offset))})}this.car&&this.car.speed>2&&this.createExhaustSmoke(),this.car&&this.car.speed>15&&this.createSpeedLines(),this.checkGarageProximity(),this.updateCollectibles(e),this.checkCollectibles(),this.updateUI(),this.updateCamera(),this.updateEngineSound(),this.updateMinimap(),this.dayNightCycle&&(this.dayNightCycle.update(),this.streetLamps.length>0&&function(e,t){if(!e||0===e.length)return;let i=0;t>.7?i=1:t>.3&&(i=(t-.3)/(.7-.3)),e.forEach(e=>{const t=e.userData,s=t.pointLight.intensity/2,n=s+.1*(i-s);if(t.pointLight.intensity=2*n,t.glowMaterial.opacity=.4*n,e.traverse(e=>{e.isMesh&&e.material&&e.material.emissive&&(e.material.emissiveIntensity=1.5*n)}),n>.1){const i=1+.02*Math.sin(.003*Date.now()+e.position.x);t.pointLight.intensity*=i,e.traverse(e=>{e.isMesh&&e.material&&e.material.emissive&&(e.material.emissiveIntensity*=i)})}})}(this.streetLamps,this.dayNightCycle.timeOfDay)),this.streetLamps.length>0&&function(e){if(!e||0===e.length)return;const t=.001*Date.now();e.forEach((e,i)=>{const s=e.userData;if(s.glow&&s.pointLight.intensity>.1){const e=1.5+.1*Math.sin(2*t+i);s.glow.scale.set(e,e,e)}})}(this.streetLamps),this.cacti.length>0&&function(e){if(!e||0===e.length)return;const t=5e-4*Date.now();e.forEach((e,i)=>{const s=.5*i;e.rotation.x=.02*Math.sin(.5*t+s),e.rotation.z=.02*Math.cos(.5*t*.7+s)})}(this.cacti),this.composer&&this.postProcessingEnabled?(this.car&&function(e,t,i=25){const s=Math.min(t/i,1),n=e.passes.find(e=>e instanceof ie);n&&(n.strength=.6+.4*s);const r=e.passes.find(e=>e.uniforms&&e.uniforms.saturation);r&&(r.uniforms.saturation.value=1.2+.3*s)}(this.composer,this.car.speed,this.car.maxSpeed),this.composer.render()):this.renderer.render(this.scene,this.camera)}};
